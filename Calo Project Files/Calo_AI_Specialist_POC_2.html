<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>Calo AI Specialist â€” Retention Agent POC</title>

<style>
  body { font-family: "Tajawal","Cairo","Noto Naskh Arabic","Noto Kufi Arabic","Segoe UI","Arial",sans-serif; }
  h1, h2, h3 { margin: 0.3em 0; }
  .rtl { direction: rtl; text-align: right; }
  .ltr { direction: ltr; text-align: left; }
  .sec { margin: 12px 0 18px 0; padding: 10px 12px; border: 1px solid #eee; border-radius: 8px; }
  .code { background: #f7f7f8; border: 1px solid #eee; border-radius: 8px; padding: 10px; white-space: pre; overflow-x: auto; }
  .meta { color: #555; font-size: 0.95em; }
</style>

<body class="ltr">
  <h1>Calo AI Specialist â€” Retention Agent POC</h1>
  <div class="meta">Executive Summary, Architecture, Prompts, Code, and PRD â€” 2025-08-26</div>

  <div class="sec ltr">
    <h2>Executive Summary</h2>
    <p>This 1-minute prototype demonstrates an AI-powered retention agent that identifies at-risk subscribers and generates tailored offers in UK English or Gulf Arabic. It uses a Hugging Face Inference Router with an OpenAI-compatible client to call GPT-OSS-120B, staying model-agnostic while producing a human-readable plan and a structured JSON block for automation.</p>
  </div>

  <div class="sec rtl">
    <h2>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</h2>
    <p>ÙŠØ¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©) ÙˆÙƒÙŠÙ„Ø§Ù‹ Ø°ÙƒÙŠØ§Ù‹ Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø°ÙˆÙŠ Ø§Ù„Ø®Ø·Ø± ÙˆÙŠÙˆÙ„Ù‘Ø¯ Ø¹Ø±ÙˆØ¶Ø§Ù‹ Ù…Ø®ØµØµØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠØ©. ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Hugging Face Inference Router Ù…Ø¹ Ø¹Ù…ÙŠÙ„ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ OpenAI Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ GPT-OSS-120BØŒ Ù…Ù…Ø§ ÙŠØ¶Ù…Ù† Ø§Ù„Ù…Ø±ÙˆÙ†Ø© ÙˆØ§Ø³ØªÙ‚Ù„Ø§Ù„ÙŠØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŒ Ù…Ø¹ Ø¥Ù†ØªØ§Ø¬ Ø®Ø·Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆÙƒØªÙ„Ø© JSON Ù…Ù†Ø¸Ù…Ø© Ù„Ù„ØªÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ø§ØªÙ…ØªØ©.</p>
  </div>

  <div class="sec ltr">
    <h2>Architecture</h2>
    <pre class="code">Architecture overview
- UI: Streamlit app with Arabic and English modes.
- Data: CSV upload or synthetic sample generation.
- Scoring: Simple churn score (0 to 100) based on last_order_days, orders_month, lifetime_months, promo_used_recently, avg_spend.
- LLM: HF Inference Router endpoint with OpenAI-compatible client calling `openai/gpt-oss-120b:fireworks-ai`.
- Output: Human-readable plan with bold emphasis, plus a JSON block for system integration.</pre>
  </div>

  <div class="sec ltr">
    <h2>PRD</h2>
    <pre class="code">Product Requirements (POC)
Goals
- Reduce churn by surfacing targeted, high-quality retention offers quickly.
- Provide bilingual experience: Gulf Arabic and UK English.
- Keep model abstraction to swap providers without code churn.

Scope
- CSV ingestion and sample data generator.
- Churn scoring view with top-N at-risk customers selector.
- Recommendations generated by LLM with a plan + JSON output.

Acceptance Criteria
- App loads and allows language switching.
- User can upload CSV or generate sample data.
- Churn table shows top 5/10/15/20 at-risk customers.
- LLM returns readable paragraphs and a machine-parseable JSON array.
- Bold emphasis visible for key offer parts in both languages.

Metrics (POC)
- Time to generate recommendations.
- Qualitative evaluation of message clarity and relevance.
- Operational readiness for CRM integration (manual review in POC).

Risks & Mitigations
- Arabic rendering in PDFs: prefer DOCX/HTML export or local PDF print with Arabic fonts.
- Model variance: keep prompts deterministic and log all inputs/outputs for QA.</pre>
  </div>

  <div class="sec ltr">
    <h2>Prompts â€” English</h2>
    <pre class="code">System prompt (EN)
"You are a marketing assistant specialised for the UK market. Write in professional yet warm UK English."

User prompt (EN)
"1) For each customer, write a short friendly paragraph in English that explains the retention offer with emojis.
2) Then add a <JSON>...</JSON> block containing an array of objects with keys:
customer_id, action, message, expected_lift, rationale.
Use UK English tone. Message length â‰¤ 120 characters.
Customers: [top selected records here]"</pre>
  </div>

  <div class="sec rtl">
    <h2>Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ â€” Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h2>
    <pre class="code">Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠØ© (AR)
"Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ³ÙˆÙŠÙ‚ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆÙ…Ø®ØµØµ Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬. Ø§ÙƒØªØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø±Ø³Ø§Ù„Ø© ÙˆØ¯ÙŠØ© ÙˆÙ…Ù‡Ù†ÙŠØ©."

Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (AR)
"1) Ø§ÙƒØªØ¨ ÙÙ‚Ø±Ø© ÙˆØ¯ÙŠØ© Ù‚ØµÙŠØ±Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ ØªØ´Ø±Ø­ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù…Ø¹ Ø±Ù…ÙˆØ² ØªØ¹Ø¨ÙŠØ±ÙŠØ©.
2) Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ‚Ø±Ø§ØªØŒ Ø£Ø¶Ù ÙƒØªÙ„Ø© <JSON>...</JSON> ÙÙŠÙ‡Ø§ Ù…ØµÙÙˆÙØ© ÙƒØ§Ø¦Ù†Ø§Øª Ø¨Ø§Ù„Ø­Ù‚Ù„:
customer_id, action, message, expected_lift, rationale.
Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·ØŒ ÙˆØ·ÙˆÙ„ message â‰¤ 120 Ø­Ø±ÙÙ‹Ø§.
Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: [Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù‡Ù†Ø§]"</pre>
  </div>

  <div class="sec ltr">
    <h2>60s Demo â€” English</h2>
    <pre class="code">60s Demo Script â€” English
0â€“5s: â€œHi, Iâ€™m [Your Name]. This is a 1-minute AI prototype for Calo.â€ Launch the app.
5â€“12s: â€œI can switch Arabic or English. Iâ€™ll pick English for the UK market.â€ Choose English.
12â€“18s: â€œData can come from CSV or sample data. Iâ€™ll generate a clean sample.â€ Click Generate sample.
18â€“28s: â€œNext, we calculate churn risk.â€ Explain the score and select Top 10.
28â€“45s: â€œNow AI generates tailored retention offers.â€ Generate top 5. Mention HF Router + GPT-OSS-120B.
45â€“55s: â€œWe get a clean plan plus structured JSON. Key parts are bold, with expected impact per rec.â€
55â€“60s: â€œReady as a POC and can plug into CRM and campaigns. Thank you.â€</pre>
  </div>

  <div class="sec rtl">
    <h2>Ù†Øµ Ø§Ù„Ø¯ÙŠÙ…Ùˆ 60 Ø«Ø§Ù†ÙŠØ© â€” Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h2>
    <pre class="code">Ù†Øµ Ø§Ù„Ø¯ÙŠÙ…Ùˆ 60 Ø«Ø§Ù†ÙŠØ© â€” Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
0â€“5 Ø«: â€œÙ…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ [Ø§Ø³Ù…Ùƒ]. Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©.â€ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
5â€“12 Ø«: â€œØ£Ù‚Ø¯Ø± Ø£Ø¨Ø¯Ù‘Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©. Ø³Ø£Ø®ØªØ§Ø± Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠ.â€ Ø§Ø®ØªÙŠØ§Ø± English.
12â€“18 Ø«: â€œØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† CSV Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ø³Ø£ÙˆÙ„Ù‘Ø¯ Ø¹ÙŠÙ†Ø© Ù†Ø¸ÙŠÙØ©.â€ Ø¶ØºØ· Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª.
18â€“28 Ø«: â€œÙ†Ø­Ø³Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨.â€ Ø´Ø±Ø­ Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù„Ù‰ 10.
28â€“45 Ø«: â€œÙ†ÙˆÙ„Ù‘Ø¯ Ø¹Ø±ÙˆØ¶ Ø§Ø­ØªÙØ§Ø¸ Ù…Ø®ØµØµØ©.â€ ØªÙˆÙ„ÙŠØ¯ Ø£Ø¹Ù„Ù‰ 5. Ø°ÙƒØ± HF Router + GPT-OSS-120B.
45â€“55 Ø«: â€œØ®Ø·Ø© Ù…Ù†Ø³Ù‘Ù‚Ø© ÙˆJSON Ù…Ù†Ø¸Ù‘Ù…ØŒ Ù…Ø¹ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ø®Ø· Ø¹Ø±ÙŠØ¶ ÙˆØªØ£Ø«ÙŠØ± Ù…ØªÙˆÙ‚Ù‘Ø¹.â€
55â€“60 Ø«: â€œØ¬Ø§Ù‡Ø²Ø© ÙƒÙ€ POC ÙˆÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ CRM ÙˆØ§Ù„Ø­Ù…Ù„Ø§Øª. Ø´ÙƒØ±Ø§Ù‹.â€</pre>
  </div>

  <div class="sec ltr">
    <h2>Code â€” app.py</h2>
    <pre class="code"># app.py
# export HF_TOKEN=&quot;hf_...&quot;
# streamlit run app.py

import os
import re
import json
import html
import streamlit as st
import pandas as pd
import numpy as np
from openai import OpenAI

# -----------------------------
# Settings
# -----------------------------
HF_ROUTER = &quot;https://router.huggingface.co/v1&quot;
DEFAULT_MODEL = &quot;openai/gpt-oss-120b:fireworks-ai&quot;


# -----------------------------
# Client and state
# -----------------------------
def make_client() -&gt; OpenAI:
    token = os.environ.get(&quot;HF_TOKEN&quot;)
    if not token:
        raise EnvironmentError(&quot;HF_TOKEN not set. Please set your Hugging Face token.&quot;)
    return OpenAI(base_url=HF_ROUTER, api_key=token)


def init_state():
    if &quot;model&quot; not in st.session_state:
        st.session_state.model = DEFAULT_MODEL
    if &quot;plan_text&quot; not in st.session_state:
        st.session_state.plan_text = &quot;&quot;
    if &quot;parsed_recs&quot; not in st.session_state:
        st.session_state.parsed_recs = None
    if &quot;lang&quot; not in st.session_state:
        st.session_state.lang = &quot;Arabic&quot;
    if &quot;dialect&quot; not in st.session_state:
        st.session_state.dialect = &quot;Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ©&quot;


# -----------------------------
# LLM helpers
# -----------------------------
def extract_text_from_completion(completion) -&gt; str:
    try:
        choices = getattr(completion, &quot;choices&quot;, None) or completion.get(&quot;choices&quot;)
        first = choices[0]
        msg = getattr(first, &quot;message&quot;, None) or first.get(&quot;message&quot;)
        if isinstance(msg, dict):
            return msg.get(&quot;content&quot;, &quot;&quot;)
        return getattr(msg, &quot;content&quot;, &quot;&quot;) or getattr(first, &quot;text&quot;, &quot;&quot;) or &quot;&quot;
    except Exception:
        try:
            return json.dumps(completion, ensure_ascii=False)
        except Exception:
            return str(completion)


def split_natural_and_json(full_text: str):
    if not full_text:
        return &quot;&quot;, None
    m = re.search(r&quot;&lt;JSON&gt;([\s\S]*?)&lt;/JSON&gt;&quot;, full_text, re.IGNORECASE)
    if m:
        natural = (full_text[:m.start()] + full_text[m.end():]).strip()
        return natural, m.group(1).strip()
    m2 = re.search(r&quot;(\{[\s\S]*?\}|\[[\s\S]*?\])&quot;, full_text)
    if m2:
        json_text = m2.group(1).strip()
        natural = (full_text[:m2.start()] + full_text[m2.end():]).strip()
        return natural, json_text
    return full_text, None


# -----------------------------
# Data helpers
# -----------------------------
def validate_uploaded_df(df: pd.DataFrame):
    required = {
        &quot;customer_id&quot;,
        &quot;last_order_days&quot;,
        &quot;avg_spend&quot;,
        &quot;orders_month&quot;,
        &quot;lifetime_months&quot;,
        &quot;preference&quot;,
        &quot;promo_used_recently&quot;,
    }
    missing = [c for c in required if c not in df.columns]
    if missing:
        return (&quot;Missing columns: &quot; if st.session_state.lang == &quot;English&quot; else &quot;Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ©: &quot;) + &quot;, &quot;.join(missing)
    return None


def generate_sample_subscribers(n=60, lang=&quot;Arabic&quot;):
    np.random.seed(42)
    prefs = (
        [&quot;Ù†Ø¨Ø§ØªÙŠ&quot;, &quot;Ù†Ø¨Ø§ØªÙŠ ØµØ§Ø±Ù…&quot;, &quot;Ù…Ø­Ø¨ Ø§Ù„Ù„Ø­ÙˆÙ…&quot;, &quot;Ù…Ù†Ø®ÙØ¶ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª&quot;, &quot;Ù…ØªÙˆØ§Ø²Ù†&quot;]
        if lang == &quot;Arabic&quot;
        else [&quot;Vegetarian&quot;, &quot;Vegan&quot;, &quot;Meat Lover&quot;, &quot;Low Carb&quot;, &quot;Balanced&quot;]
    )
    rows = []
    for i in range(1, n + 1):
        last_order_days = int(np.clip(np.random.exponential(12), 0, 120))
        avg_spend = round(np.random.uniform(1.5, 10), 2)
        orders_month = int(np.random.poisson(3))
        lifetime_months = int(np.random.exponential(8))
        pref = np.random.choice(prefs)
        promo_used = np.random.choice([0, 1], p=[0.7, 0.3])
        rows.append(
            {
                &quot;customer_id&quot;: f&quot;C{i:04d}&quot;,
                &quot;last_order_days&quot;: last_order_days,
                &quot;avg_spend&quot;: avg_spend,
                &quot;orders_month&quot;: orders_month,
                &quot;lifetime_months&quot;: lifetime_months,
                &quot;preference&quot;: pref,
                &quot;promo_used_recently&quot;: int(promo_used),
            }
        )
    return pd.DataFrame(rows)


def churn_score(df: pd.DataFrame) -&gt; pd.Series:
    score = (
        (df[&quot;last_order_days&quot;] * 1.5)
        - (df[&quot;orders_month&quot;] * 8)
        - (df[&quot;lifetime_months&quot;] * 0.5)
        + (5 * (1 - (df[&quot;promo_used_recently&quot;])))
    ) / (df[&quot;avg_spend&quot;] + 1)
    s = 100 * (score - score.min()) / (score.max() - score.min() + 1e-6)
    return s.round(1)


# -----------------------------
# UI styling and rendering
# -----------------------------
def style_primary(color: str, lang: str):
    direction_css = (
        \&quot;&quot;&quot;
        .stApp { direction: rtl; }
        .stMarkdown, .stText { text-align: right; }
        [data-testid=&quot;stSidebar&quot;] { direction: rtl; }
        \&quot;&quot;&quot;
        if lang == &quot;Arabic&quot;
        else \&quot;&quot;&quot;
        .stApp { direction: ltr; }
        .stMarkdown, .stText { text-align: left; }
        [data-testid=&quot;stSidebar&quot;] { direction: ltr; }
        \&quot;&quot;&quot;
    )
    st.markdown(
        f\&quot;\&quot;\&quot;
        &lt;style&gt;
        {direction_css}
        body, div, p, span {{
            font-family: &quot;Tajawal&quot;,&quot;Cairo&quot;,&quot;Noto Kufi Arabic&quot;,&quot;Segoe UI&quot;,Arial,sans-serif;
        }}
        div.stButton&gt;button {{
            background: {color};
            color: white;
            border-radius: 8px;
            border: 0;
            padding: 0.5rem 0.8rem;
        }}
        .highlight {{
            background: rgba(0,0,0,0.03);
            padding: 0.9rem 1.1rem;
            border-radius: 10px;
            border: 1px solid #eee;
        }}
        .plan-wrapper {{
            background: #ffffff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 1rem 1.25rem;
        }}
        .plan-wrapper h3 {{
            margin: 0 0 12px 0;
            font-weight: 700;
        }}
        .plan-line {{
            line-height: 1.9;
            margin: 0 0 8px 0;
            font-size: 1.05rem;
        }}
        &lt;/style&gt;
        \&quot;\&quot;\&quot;,
        unsafe_allow_html=True,
    )


def render_bold(text: str) -&gt; str:
    esc = html.escape(text)
    esc = re.sub(r&quot;\\*\\*(.+?)\\*\\*&quot;, r&quot;&lt;strong&gt;\\1&lt;/strong&gt;&quot;, esc)
    esc = re.sub(r&quot;__(.+?)__&quot;, r&quot;&lt;strong&gt;\\1&lt;/strong&gt;&quot;, esc)
    esc = re.sub(r&quot;(\\d+(?:\\.\\d+)?\\s*[Ùª%])&quot;, r&quot;&lt;strong&gt;\\1&lt;/strong&gt;&quot;, esc)
    for pat in [r&quot;\\bdiscount\\b&quot;, r&quot;\\boffer\\b&quot;, r&quot;\\bfree\\s+(?:delivery|shipping)\\b&quot;, r&quot;\\bvoucher\\b&quot;, r&quot;\\bcoupon\\b&quot;, r&quot;\\bpromo\\b&quot;, r&quot;\\bcode\\b&quot;, r&quot;\\bpoints?\\b&quot;, r&quot;\\bdouble\\s+points?\\b&quot;, r&quot;\\bsave\\b&quot;]:
        esc = re.sub(pat, lambda m: f&quot;&lt;strong&gt;{m.group(0)}&lt;/strong&gt;&quot;, esc, flags=re.IGNORECASE)
    for pat in [r&quot;Ø®ØµÙ…&quot;, r&quot;Ø¹Ø±Ø¶&quot;, r&quot;ÙƒÙˆØ¨ÙˆÙ†&quot;, r&quot;Ù‚Ø³ÙŠÙ…Ø©&quot;, r&quot;Ø±Ù…Ø²&quot;, r&quot;Ù†Ù‚Ø§Ø·&quot;, r&quot;Ù…Ø¶Ø§Ø¹ÙØ©\\s+Ø§Ù„Ù†Ù‚Ø§Ø·&quot;, r&quot;(?:ØªÙˆØµÙŠÙ„|Ø´Ø­Ù†)\\s+Ù…Ø¬Ø§Ù†ÙŠ&quot;, r&quot;Ù…Ø¬Ø§Ù†ÙŠ&quot;]:
        esc = re.sub(pat, lambda m: f&quot;&lt;strong&gt;{m.group(0)}&lt;/strong&gt;&quot;, esc)
    return esc


def render_plan_text(text: str, lang: str) -&gt; str:
    lines = [ln.strip() for ln in text.splitlines()]
    cleaned = [l for l in lines if l]
    paras_html = [f&quot;&lt;p class=&#x27;plan-line&#x27;&gt;{render_bold(l)}&lt;/p&gt;&quot; for l in cleaned]
    title = &quot;Plan - English text&quot; if lang == &quot;English&quot; else &quot;Ø§Ù„Ø®Ø·Ø© - Ù†Øµ Ø¹Ø±Ø¨ÙŠ&quot;
    return f&quot;&lt;div class=&#x27;plan-wrapper&#x27;&gt;&lt;h3&gt;{title}&lt;/h3&gt;{&#x27;&#x27;.join(paras_html)}&lt;/div&gt;&quot;


# -----------------------------
# Sidebar
# -----------------------------
def sidebar(lang: str):
    st.header(&quot;Settings&quot; if lang == &quot;English&quot; else &quot;Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª&quot;)
    lang_choice = st.radio(&quot;Language / Ø§Ù„Ù„ØºØ©&quot;, [&quot;Arabic&quot;, &quot;English&quot;], index=0 if lang == &quot;Arabic&quot; else 1)
    st.session_state.lang = lang_choice
    lang = lang_choice
    if lang == &quot;Arabic&quot;:
        st.session_state.dialect = st.selectbox(&quot;Ø§Ù„Ù„Ù‡Ø¬Ø©&quot;, [&quot;Ø§Ù„ÙØµØ­Ù‰&quot;, &quot;Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ©&quot;], index=1)
    if lang == &quot;English&quot;:
        theme = st.selectbox(&quot;Theme color&quot;, [&quot;Green&quot;, &quot;Blue&quot;, &quot;Purple&quot;])
        color_map = {&quot;Green&quot;: &quot;#22c55e&quot;, &quot;Blue&quot;: &quot;#3b82f6&quot;, &quot;Purple&quot;: &quot;#8b5cf6&quot;}
    else:
        theme = st.selectbox(&quot;Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©&quot;, [&quot;Ø£Ø®Ø¶Ø±&quot;, &quot;Ø£Ø²Ø±Ù‚&quot;, &quot;Ø¨Ù†ÙØ³Ø¬ÙŠ&quot;])
        color_map = {&quot;Ø£Ø®Ø¶Ø±&quot;: &quot;#22c55e&quot;, &quot;Ø£Ø²Ø±Ù‚&quot;: &quot;#3b82f6&quot;, &quot;Ø¨Ù†ÙØ³Ø¬ÙŠ&quot;: &quot;#8b5cf6&quot;}
    style_primary(color_map.get(theme, &quot;#22c55e&quot;), lang)
    st.session_state.model = st.text_input(&quot;Model ID&quot; if lang == &quot;English&quot; else &quot;Ù…Ø¹Ø±Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬&quot;, value=st.session_state.model)
    st.markdown(&quot;**Data source**&quot; if lang == &quot;English&quot; else &quot;**Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**&quot;)
    uploaded = st.file_uploader(&quot;Upload CSV&quot; if lang == &quot;English&quot; else &quot;Ø§Ø±ÙØ¹ Ù…Ù„Ù CSV&quot;, type=[&quot;csv&quot;])
    if uploaded is not None:
        try:
            up_df = pd.read_csv(uploaded)
            err = validate_uploaded_df(up_df)
            if err:
                st.error(err)
            else:
                st.session_state[&quot;subscribers_df&quot;] = up_df
                st.success(&quot;CSV uploaded successfully.&quot; if lang == &quot;English&quot; else &quot;ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª CSV Ø¨Ù†Ø¬Ø§Ø­.&quot;)
        except Exception as e:
            st.error((&quot;Failed to upload file: &quot; if lang == &quot;English&quot; else &quot;ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: &quot;) + str(e))
    if st.button(&quot;Generate sample data&quot; if lang == &quot;English&quot; else &quot;Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©&quot;):
        st.session_state[&quot;subscribers_df&quot;] = generate_sample_subscribers(lang=lang)
    if st.button(&quot;Clear data&quot; if lang == &quot;English&quot; else &quot;Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª&quot;):
        st.session_state.pop(&quot;subscribers_df&quot;, None)
        st.session_state.plan_text = &quot;&quot;
        st.session_state.parsed_recs = None
        st.success(&quot;Cleared.&quot; if lang == &quot;English&quot; else &quot;ØªÙ… Ø§Ù„Ù…Ø³Ø­.&quot;)


# -----------------------------
# Tabs
# -----------------------------
def tab_data_view(df: pd.DataFrame, lang: str):
    st.subheader(&quot;Data preview&quot; if lang == &quot;English&quot; else &quot;Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª&quot;)
    st.dataframe(df, use_container_width=True)
    with st.expander(&quot;Data quality tips&quot; if lang == &quot;English&quot; else &quot;Ù†ØµØ§Ø¦Ø­ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª&quot;):
        st.markdown(
            &quot;- Ensure all required columns exist.\\n- Boolean values like promo_used_recently must be 0 or 1.\\n- Numeric columns should not contain text.&quot;
            if lang == &quot;English&quot;
            else &quot;- ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.\\n- Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© ÙƒÙ€ promo_used_recently ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 0 Ø£Ùˆ 1.\\n- Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙ… Ù†ØµÙŠØ©.&quot;
        )


def tab_scoring_view(df: pd.DataFrame, lang: str):
    st.subheader(&quot;Churn score calculation&quot; if lang == &quot;English&quot; else &quot;Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨&quot;)
    try:
        df[&quot;churn_score&quot;] = churn_score(df)
    except Exception as e:
        st.error(f&quot;Failed to calculate churn score: {e}&quot; if lang == &quot;English&quot; else f&quot;ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨: {e}&quot;)
        st.stop()
    c1, c2, c3, c4 = st.columns(4)
    c1.metric(&quot;Customers&quot; if lang == &quot;English&quot; else &quot;Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡&quot;, len(df))
    c2.metric(&quot;Avg score&quot; if lang == &quot;English&quot; else &quot;Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø©&quot;, f&quot;{df[&#x27;churn_score&#x27;].mean():.1f}%&quot;)
    c3.metric(&quot;Max score&quot; if lang == &quot;English&quot; else &quot;Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©&quot;, f&quot;{df[&#x27;churn_score&#x27;].max():.1f}%&quot;)
    c4.metric(&quot;Min score&quot; if lang == &quot;English&quot; else &quot;Ø£Ø¯Ù†Ù‰ Ø¯Ø±Ø¬Ø©&quot;, f&quot;{df[&#x27;churn_score&#x27;].min():.1f}%&quot;)
    top_n = st.selectbox(&quot;Show top at-risk customers&quot; if lang == &quot;English&quot; else &quot;Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø®Ø·Ø±Ø§Ù‹&quot;, [5, 10, 15, 20], index=0)
    st.dataframe(
        df.sort_values(&quot;churn_score&quot;, ascending=False).head(top_n),
        use_container_width=True,
        column_config={
            &quot;churn_score&quot;: st.column_config.ProgressColumn(
                &quot;Churn score&quot; if lang == &quot;English&quot; else &quot;Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨&quot;,
                help=&quot;Relative score 0 to 100&quot; if lang == &quot;English&quot; else &quot;Ù‚ÙŠÙ…Ø© Ù†Ø³Ø¨ÙŠØ© Ù…Ù† 0 Ø¥Ù„Ù‰ 100&quot;,
                min_value=0, max_value=100, format=&quot;%.1f%%&quot;,
            )
        },
    )
    with st.expander(&quot;How churn score is calculated&quot; if lang == &quot;English&quot; else &quot;ÙƒÙŠÙ Ù†Ø­Ø³Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨&quot;):
        st.markdown(
            &quot;Composite score: longer since last order raises risk, frequent monthly orders and long lifetime reduce risk, and recent promo use reduces risk. Normalised to 0 to 100.&quot;
            if lang == &quot;English&quot;
            else &quot;Ù†Ø­Ø³Ø¨ Ø¯Ø±Ø¬Ø© Ù…Ø±ÙƒØ¨Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¹Ø¯Ø© Ø¹ÙˆØ§Ù…Ù„: ØªØ£Ø®Ø± Ø¢Ø®Ø± Ø·Ù„Ø¨ ÙŠØ±ÙØ¹ Ø§Ù„Ø®Ø·Ø±ØŒ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ·ÙˆÙ„ Ø§Ù„Ø¹Ù…Ø± ÙŠÙ‚Ù„Ù„Ø§Ù† Ø§Ù„Ø®Ø·Ø±ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ø±Ø¶ ØªØ±ÙˆÙŠØ¬ÙŠ Ù…Ø¤Ø®Ø±Ø§Ù‹ ÙŠÙ‚Ù„Ù„ Ø§Ù„Ø®Ø·Ø±. Ù†Ø·Ø¨Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ Ù†Ø·Ø§Ù‚ 0 Ø­ØªÙ‰ 100.&quot;
        )


def _emoji_for_lift(lift: str) -&gt; str:
    s = str(lift or &quot;&quot;).strip().lower()
    if s in [&quot;high&quot;, &quot;Ø¹Ø§Ù„ÙŠ&quot;, &quot;Ù…Ø±ØªÙØ¹&quot;]:
        return &quot;ğŸ”¥&quot;
    if s in [&quot;medium&quot;, &quot;Ù…ØªÙˆØ³Ø·&quot;]:
        return &quot;ğŸ‘&quot;
    if s in [&quot;low&quot;, &quot;Ù…Ù†Ø®ÙØ¶&quot;]:
        return &quot;ğŸ””&quot;
    return &quot;ğŸ“ˆ&quot;


def tab_recommendations_view(df: pd.DataFrame, lang: str, dialect: str):
    st.subheader(&quot;Generate recommendations&quot; if lang == &quot;English&quot; else &quot;ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠØ§Øª&quot;)
    df_scored = df.copy()
    if &quot;churn_score&quot; not in df_scored.columns:
        df_scored[&quot;churn_score&quot;] = churn_score(df_scored)
    top_k = st.selectbox(&quot;Number of top at-risk customers&quot; if lang == &quot;English&quot; else &quot;Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø®Ø·Ø±Ø§Ù‹&quot;, [5, 10, 15, 20], index=0)
    selected = df_scored.sort_values(&quot;churn_score&quot;, ascending=False).head(top_k)
    st.dataframe(
        selected[[&quot;customer_id&quot;, &quot;last_order_days&quot;, &quot;orders_month&quot;, &quot;avg_spend&quot;, &quot;churn_score&quot;]],
        use_container_width=True,
        column_config={
            &quot;churn_score&quot;: st.column_config.ProgressColumn(
                &quot;Churn score&quot; if lang == &quot;English&quot; else &quot;Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨&quot;,
                min_value=0, max_value=100, format=&quot;%.1f%%&quot;,
            )
        },
    )
    if st.button(&quot;Generate retention recommendations&quot; if lang == &quot;English&quot; else &quot;ØªÙˆÙ„ÙŠØ¯ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø§Ø­ØªÙØ§Ø¸&quot;):
        top_records = selected.to_dict(orient=&quot;records&quot;)
        if lang == &quot;Arabic&quot;:
            sys_prompt = &quot;Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ³ÙˆÙŠÙ‚ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆÙ…Ø®ØµØµ Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬. Ø§ÙƒØªØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø±Ø³Ø§Ù„Ø© ÙˆØ¯ÙŠØ© ÙˆÙ…Ù‡Ù†ÙŠØ©.&quot;
            user_prompt = (
                f&quot;Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„Ù‡Ø¬Ø©: {dialect}. &quot;
                &quot;1) Ø§ÙƒØªØ¨ ÙÙ‚Ø±Ø© ÙˆØ¯ÙŠØ© Ù‚ØµÙŠØ±Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ ØªØ´Ø±Ø­ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù…Ø¹ Ø±Ù…ÙˆØ² ØªØ¹Ø¨ÙŠØ±ÙŠØ©. &quot;
                &quot;2) Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ‚Ø±Ø§ØªØŒ Ø£Ø¶Ù ÙƒØªÙ„Ø© &lt;JSON&gt;...&lt;/JSON&gt; ÙÙŠÙ‡Ø§ Ù…ØµÙÙˆÙØ© ÙƒØ§Ø¦Ù†Ø§Øª Ø¨Ø§Ù„Ø­Ù‚Ù„: &quot;
                &quot;customer_id, action, message, expected_lift, rationale. &quot;
                &quot;Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·ØŒ ÙˆØ·ÙˆÙ„ message â‰¤ 120 Ø­Ø±ÙÙ‹Ø§. &quot;
                f&quot;Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: {json.dumps(top_records, ensure_ascii=False)}&quot;
            )
        else:
            sys_prompt = &quot;You are a marketing assistant specialised for the UK market. Write in professional yet warm UK English.&quot;
            user_prompt = (
                &quot;1) For each customer, write a short friendly paragraph in English that explains the retention offer with emojis. &quot;
                &quot;2) Then add a &lt;JSON&gt;...&lt;/JSON&gt; block containing an array of objects with keys: &quot;
                &quot;customer_id, action, message, expected_lift, rationale. &quot;
                &quot;Use UK English tone. Message length â‰¤ 120 characters. &quot;
                f&quot;Customers: {json.dumps(top_records, ensure_ascii=False)}&quot;
            )
        with st.spinner(&quot;Generating plan and recommendations...&quot; if lang == &quot;English&quot; else &quot;Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª&quot;):
            try:
                client = make_client()
                completion = client.chat.completions.create(
                    model=st.session_state.model,
                    messages=[{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: sys_prompt}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: user_prompt}],
                )
                full_text = extract_text_from_completion(completion)
                natural, json_text = split_natural_and_json(full_text)
                if natural:
                    st.session_state.plan_text = natural
                parsed = None
                if json_text:
                    try:
                        parsed = json.loads(json_text)
                    except Exception:
                        parsed = None
                        st.warning(&quot;Could not parse JSON.&quot; if lang == &quot;English&quot; else &quot;ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© JSON.&quot;)
                st.session_state.parsed_recs = parsed
                st.success(&quot;Generated successfully.&quot; if lang == &quot;English&quot; else &quot;ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.&quot;)
            except Exception as e:
                st.error((&quot;Failed: &quot; if lang == &quot;English&quot; else &quot;ÙØ´Ù„: &quot;) + str(e))
    if st.session_state.plan_text:
        st.markdown(render_plan_text(st.session_state.plan_text, lang), unsafe_allow_html=True)
    if isinstance(st.session_state.parsed_recs, list):
        st.markdown(&quot;### Recommendations&quot; if lang == &quot;English&quot; else &quot;### Ø§Ù„ØªÙˆØµÙŠØ§Øª&quot;)
        for rec in st.session_state.parsed_recs:
            cid = rec.get(&quot;customer_id&quot;, &quot;-&quot;)
            action = rec.get(&quot;action&quot;, &quot;&quot;)
            message_raw = rec.get(&quot;message&quot;, &quot;&quot;)
            lift = rec.get(&quot;expected_lift&quot;, &quot;&quot;)
            rationale = rec.get(&quot;rationale&quot;, &quot;&quot;)
            emoji = _emoji_for_lift(lift)
            with st.expander(f&quot;{emoji} {cid} - {action}&quot;):
                st.markdown((&quot;**Message:** &quot; if lang == &quot;English&quot; else &quot;**Ø§Ù„Ø±Ø³Ø§Ù„Ø©:** &quot;) + render_bold(message_raw), unsafe_allow_html=True)
                st.markdown((&quot;**Expected impact:** &quot; if lang == &quot;English&quot; else &quot;**Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:** &quot;) + f&quot;**{html.escape(str(lift))}**&quot;)
                if rationale:
                    st.markdown((&quot;**Rationale:** &quot; if lang == &quot;English&quot; else &quot;**Ø§Ù„Ø³Ø¨Ø¨:** &quot;) + html.escape(str(rationale)))


# -----------------------------
# App
# -----------------------------
def app():
    st.set_page_config(page_title=&quot;Subscription Growth Agent&quot;, layout=&quot;wide&quot;, initial_sidebar_state=&quot;expanded&quot;)
    init_state()
    with st.sidebar:
        sidebar(st.session_state.lang)
    if st.session_state.lang == &quot;English&quot;:
        st.title(&quot;ğŸŒ Subscription Growth Agent - Calo&quot;)
        st.markdown(&quot;ğŸ¤– Helps identify at-risk customers and generate retention recommendations.&quot;)
    else:
        st.title(&quot;ğŸŒ ÙˆÙƒÙŠÙ„ Ù†Ù…Ùˆ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª - Calo&quot;)
        st.markdown(&quot;ğŸ¤– ÙŠØ³Ø§Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø°ÙˆÙŠ Ø®Ø·Ø± Ø§Ù„Ø§Ù†Ø³Ø­Ø§Ø¨ ÙˆØªÙˆÙ„ÙŠØ¯ ØªÙˆØµÙŠØ§Øª Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.&quot;)
    if &quot;subscribers_df&quot; not in st.session_state:
        st.info(&quot;No data yet. Upload a CSV or generate sample data from the sidebar.&quot; if st.session_state.lang == &quot;English&quot; else &quot;Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø±ÙØ¹ CSV Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ.&quot;)
        st.stop()
    df = st.session_state[&quot;subscribers_df&quot;]
    tabs = ([&quot;Data&quot;, &quot;Scoring&quot;, &quot;Recommendations&quot;] if st.session_state.lang == &quot;English&quot; else [&quot;Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª&quot;, &quot;Ø§Ù„Ø­Ø³Ø§Ø¨&quot;, &quot;Ø§Ù„ØªÙˆØµÙŠØ§Øª&quot;])
    tab_data, tab_scoring, tab_reco = st.tabs(tabs)
    with tab_data:
        tab_data_view(df, st.session_state.lang)
    with tab_scoring:
        tab_scoring_view(df, st.session_state.lang)
    with tab_reco:
        tab_recommendations_view(df, st.session_state.lang, st.session_state.dialect if st.session_state.lang == &quot;Arabic&quot; else &quot;&quot;)
if __name__ == &quot;__main__&quot;:
    try:
        app()
    except EnvironmentError as e:
        st.error(str(e))
    except Exception as e:
        st.exception(e)
</pre>
  </div>
</body>
</html>
